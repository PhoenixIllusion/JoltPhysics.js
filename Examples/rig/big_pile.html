<!DOCTYPE html>
<html lang="en">
	<head>
		<title>JoltPhysics.js demo</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="stylesheet" type="text/css" href="../style.css">
	</head>
	<body>
		<div id="container">Loading...</div>
		<div id="info">JoltPhysics.js Big Pile Rig demo<br/>
      <label>Pile Size: <select id="mPileSize"></select></label>
		</div>

		<script src="../js/three/three.min.js"></script>
		<script src="../js/three/OrbitControls.js"></script>
		<script src="../js/three/WebGL.js"></script>
		<script src="../js/three/stats.min.js"></script>
		<script src="../js/example.js"></script>
		<script src="../js/object_stream.js"></script>
		<script src="../js/ragdoll_loader.js"></script>

		<script type="module">
			// In case you haven't built the library yourself, replace URL with: https://www.unpkg.com/jolt-physics/dist/jolt-physics.wasm-compat.js
			import initJolt from './../js/jolt-physics.wasm-compat.js';

			const texLoader = new THREE.TextureLoader();
			const texture = texLoader.load('data:image/gif;base64,R0lGODdhAgACAIABAAAAAP///ywAAAAAAgACAAACA0QCBQA7');
			texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
			texture.offset.set(0, 0);
			texture.repeat.set(20, 20);
			texture.magFilter = THREE.NearestFilter;

      function renderRagdoll(mRagdoll) {
        const bodyThreeJs = [];
        let bodyCount = mRagdoll.GetBodyCount();
        for(let i=0; i < bodyCount; i++) {
          const bodyID = mRagdoll.GetBodyID(i);
          let body = physicsSystem.GetBodyLockInterfaceNoLock().TryGetBody(bodyID);
          addToScene(body, 0xFF00FF);
          bodyThreeJs.push(dynamicObjects[dynamicObjects.length-1]);
        }
        return bodyThreeJs;
      }

			initJolt().then(async function (Jolt) {

				// Initialize this example
				initExample(Jolt, (mTime, mDeltaTime) => {

        });
        

        scene.add(new THREE.AmbientLight(0xFFFFFF,0.2))
				// Create a basic floor
				const floor = createFloor();
        const shape = bodyInterface.GetShape(floor.GetID());
				const floorModel = dynamicObjects[dynamicObjects.length-1];
				floorModel.material.map = texture;

        const piles = [5, 10, 20, 30, 40];
        const dropdown = document.getElementById('mPileSize');
        piles.forEach(dist => {
          const option = document.createElement('option');
          option.value = dist;
          option.innerText = 'Pile '+dist;
          dropdown.appendChild(option);
        });
        dropdown.value = 0;

        const mRagdollSettings = await RagdollLoader.load(Jolt, "../assets/Human/Human.tof", Jolt.EMotionType_Dynamic, "Ragdoll");
        const animation = await RagdollLoader.loadAnimation(Jolt, "../assets/Human/animations/dead_pose1.tof");
        const mPose = new Jolt.SkeletonPose();
				mPose.SetSkeleton(mRagdollSettings.GetSkeleton());
	      animation.Sample(0.0, mPose);

        const sIdentity = Jolt.Quat.prototype.sIdentity();
        const sZero = Jolt.Vec3.prototype.sZero();

        const cPileSize = 15;
        const rotation = [];
        const angle = () => Math.random() * Math.PI;
        for (let i = 0; i < cPileSize; ++i)
		      rotation.push(Jolt.Quat.prototype.sRotation(Jolt.Vec3.prototype.sAxisY(), angle()) /** mPose.GetJoint(0).mRotation*/);

        const rootOffset = new Jolt.Vec3();
        for (let i = 0; i < cPileSize; ++i)
        {
            // Create ragdoll
            const ragdoll = mRagdollSettings.CreateRagdoll(0, 0, physicsSystem);

            // Override root
            const root = mPose.GetJoint(0);
            root.mTranslation = sZero;
            root.mRotation = rotation[i];
            rootOffset.Set(3*Math.random() -1.5, 2.0 + 0.6 * i, 3*Math.random() -1.5);
            mPose.SetRootOffset(rootOffset);
            mPose.CalculateJointMatrices();

            // Drive to pose
            ragdoll.SetPose(mPose);
            ragdoll.DriveToPoseUsingMotors(mPose);
            ragdoll.AddToPhysicsSystem(Jolt.EActivation_Activate);
            renderRagdoll(ragdoll);
        }

				camera.position.z = -9;
				camera.position.y = 3;
			});
		</script>
	</body>
</html>
