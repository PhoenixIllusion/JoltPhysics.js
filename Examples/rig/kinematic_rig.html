<!DOCTYPE html>
<html lang="en">
	<head>
		<title>JoltPhysics.js demo</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="stylesheet" type="text/css" href="../style.css">
	</head>
	<body>
		<div id="container">Loading...</div>
		<div id="info">JoltPhysics.js Load Rig demo<br/>
      <label>Constraint Type: <select id="sAnimations"></select></label>
		</div>

		<script src="../js/three/three.min.js"></script>
		<script src="../js/three/OrbitControls.js"></script>
		<script src="../js/three/WebGL.js"></script>
		<script src="../js/three/stats.min.js"></script>
		<script src="../js/example.js"></script>
		<script src="../js/object_stream.js"></script>
		<script src="../js/ragdoll_loader.js"></script>

		<script type="module">
			// In case you haven't built the library yourself, replace URL with: https://www.unpkg.com/jolt-physics/dist/jolt-physics.wasm-compat.js
			import initJolt from './../js/jolt-physics.wasm-compat.js';


			initJolt().then(async function (Jolt) {

        const sAnimations = [ 
                "Neutral",
                "Walk",
                "Sprint",
                "Dead_Pose1",
                "Dead_Pose2",
                "Dead_Pose3",
                "Dead_Pose4" ];

        let sAnimationName = "Walk";

        let mAnimation, mPose, mRagdoll;

				// Initialize this example
				initExample(Jolt, (mTime, mDeltaTime) => {
          if(mAnimation && mPose && mRagdoll) {
            mAnimation.Sample(mTime-mDeltaTime, mPose);
	          mPose.CalculateJointMatrices();

            mAnimation.Sample(mTime, mPose);
	          mPose.CalculateJointMatrices();
	          mRagdoll.DriveToPoseUsingKinematics(mPose, mDeltaTime);
          }
        });

        scene.add(new THREE.AmbientLight(0xFFFFFF,0.2))
				// Create a basic floor
				createFloor();

        const extent = new Jolt.Vec3(0.2, 0.2, 0.2)
        const position = new Jolt.Vec3()
        for (let i = 0; i < 3; ++i)
          for (let j = i / 2; j < 10 - (i + 1) / 2; ++j)
          {
            position.Set(-2.0 + j * 0.4 + (i & 1? 0.2 : 0.0), 0.2 + i * 0.4, -2.0);
            //createBox(extent, Jolt.Quat.prototype.sIdentity(), position, Jolt.EMotionType_Dynamic, LAYER_MOVING, 0xcc2222);
          }



        let bodyThreeJs = [];

        const dropdown = document.getElementById('sAnimations');
        sAnimations.forEach(type => {
          const option = document.createElement('option');
          option.value = type;
          option.innerText = type;
          dropdown.appendChild(option);
        });
        dropdown.value = sAnimationName;

        const mRagdollSettings = await RagdollLoader.load(Jolt, "../assets/Human/Human.tof", Jolt.EMotionType_Dynamic, "Ragdoll");
        mRagdoll = mRagdollSettings.CreateRagdoll(0, 0, physicsSystem);
        mRagdoll.AddToPhysicsSystem(Jolt.EActivation_Activate);
        // Create ragdoll

        let bodyCount = mRagdoll.GetBodyCount();
        for(let i=0; i < bodyCount; i++) {
          const bodyID = mRagdoll.GetBodyID(i);
          let body = physicsSystem.GetBodyLockInterfaceNoLock().TryGetBody(bodyID);
          addToScene(body, 0xFF00FF);
          bodyThreeJs.push(dynamicObjects[dynamicObjects.length-1]);
        }

        mPose = new Jolt.SkeletonPose();
				mPose.SetSkeleton(mRagdollSettings.GetSkeleton());

        async function loadAnimation() {
          if(mAnimation) {
            Jolt.destroy(mAnimation);
            mAnimation = undefined;
          }
          sAnimationName = dropdown.value;
          mAnimation = await RagdollLoader.loadAnimation(Jolt, "../assets/Human/animations/"+sAnimationName.toLocaleLowerCase()+".tof");
        }

        dropdown.onchange = () => loadAnimation();

        loadAnimation();
				camera.position.z = -4;
				camera.position.y = 2;
			});
		</script>
	</body>
</html>
